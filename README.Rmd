---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# JointODE

<!-- badges: start -->

[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental) [![R-CMD-check](https://github.com/ziyangg98/JointODE/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/ziyangg98/JointODE/actions/workflows/R-CMD-check.yaml) [![Codecov test coverage](https://codecov.io/gh/ziyangg98/JointODE/graph/badge.svg)](https://app.codecov.io/gh/ziyangg98/JointODE)

<!-- badges: end -->

The **JointODE** package provides a unified framework for joint modeling of longitudinal biomarker measurements and time-to-event outcomes using ordinary differential equations (ODEs). This approach enables the simultaneous analysis of biomarker trajectories and their impact on survival outcomes.

## Model Setup

The observed biomarker measurements are modeled as:

$$V_{ij}=m_i(T_{ij})+b_i+\varepsilon_{ij},\quad i=1,\ldots,n,\quad j=1,\ldots,n_i$$

where:

-   $V_{ij}$: Observed biomarker value for subject $i$ at time $T_{ij}$
-   $m_i(t)$: True underlying biomarker trajectory
-   $b_i\sim\mathcal{N}(0,\sigma_{b}^{2})$: Subject-specific random intercept
-   $\varepsilon_{ij}\sim\mathcal{N}(0,\sigma_{e}^{2})$: Measurement error

The biomarker trajectory evolution is characterized by the following second-order differential equation:

$$
\ddot{m}_i(t) + 2 \xi \omega_n \dot{m}_i(t) + \omega_n^2 m_i(t) = k \omega_n^2 \boldsymbol{X}_i(t)^{\top} \boldsymbol{\beta},
$$

where $\dot{m}_i(t)$ and $\ddot{m}_i(t)$ denote the biomarkerâ€™s velocity and acceleration, respectively, and $\boldsymbol{X}_i(t)$ denotes time-varying covariates. The parameters have the usual interpretations: $\omega_n > 0$ is the natural frequency, $\xi$ is the damping ratio, and $k$ is the steady-state gain.

### Survival Sub-Model

The hazard function incorporates biomarker dynamics:

$$
\lambda_i(t) = \lambda_{0}(t)\exp\left[\alpha_1 m_i(t) + \alpha_2 \dot{m}_i(t) + \mathbf{W}_i(t)^{\top}\boldsymbol{\phi}+b_{i}\right]
$$

where:

-   $\lambda_{0}(t)$: Baseline hazard (e.g., Weibull, piecewise constant)
-   $\mathbf{W}_i(t)$: Time-dependent or time-independent covariates with effects $\boldsymbol{\phi}$

For detailed mathematical derivations including ODE formulation, likelihood construction, and EM algorithm specifics, see the [technical documentation](http://gongziyang.com/JointODE/articles/technical-details.html).

## Installation

You can install the development version of JointODE from [GitHub](https://github.com/) with:

``` r
# install.packages("pak")
pak::pak("ziyangg98/JointODE")
```

## Example

Here's a basic example demonstrating typical usage:

```{r example}
library(JointODE)
library(survival)

# Load example dataset
data(sim)

# Fit joint ODE model
fit <- JointODE(
  longitudinal_formula = observed ~ x1 + x2,
  survival_formula = Surv(time, status) ~ w1 + w2,
  longitudinal_data = sim$data$longitudinal_data,
  survival_data = sim$data$survival_data,
  state = as.matrix(sim$data$state),
  spline_baseline = list(
    degree = 2,
    n_knots = 1,
    knot_placement = "equal",
    boundary_knots = NULL
  ),
  parallel = TRUE
)

# Model summary
summary(fit)

# Generate predictions
predictions <- predict(fit, times = seq(0, 10, by = 0.25))
```

## Visualization

```{r visualization, fig.width=12, fig.height=4, echo=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(patchwork)

# Prepare data
ids <- seq_len(4)
df <- lapply(ids, \(i) {
  pred <- predictions[[i]]
  obs <- filter(sim$data$longitudinal_data, id == i)
  data.frame(
    id = i, time = pred$times,
    biomarker_est = pred$biomarker, velocity_est = pred$velocity,
    acceleration_est = pred$acceleration, survival = pred$survival
  ) %>%
    left_join(select(obs, time, observed,
      biomarker_true = biomarker,
      velocity_true = velocity, acceleration_true = acceleration
    ), by = "time")
}) %>% bind_rows()

# Biomarker plot
p1 <- ggplot(df, aes(x = time)) +
  geom_line(aes(y = biomarker_est, color = "Estimated")) +
  geom_line(
    aes(y = biomarker_true, color = "True"),
    linetype = 2, na.rm = TRUE
  ) +
  geom_point(aes(y = observed, color = "Observed"), alpha = 0.3, na.rm = TRUE) +
  facet_wrap(~id, ncol = 2) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "top") +
  labs(x = "Time", y = "Biomarker", color = "")

# Dynamics plot
p2 <- df %>%
  pivot_longer(matches("(velocity|acceleration)_(est|true)"),
    names_to = c("type", "source"), names_sep = "_"
  ) %>%
  filter(!is.na(value)) %>%
  mutate(
    type = factor(type,
      levels = c("velocity", "acceleration"),
      labels = c("Velocity", "Acceleration")
    ),
    source = factor(source,
      levels = c("est", "true"),
      labels = c("Estimated", "True")
    )
  ) %>%
  ggplot(aes(x = time, y = value, color = type, linetype = source)) +
  geom_line() +
  facet_wrap(~id, scales = "free_y", ncol = 2) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "top") +
  labs(x = "Time", y = "Value", color = "Type", linetype = "Source")

# Survival plot
p3 <- ggplot(df, aes(x = time, y = survival, color = factor(id))) +
  geom_line(linewidth = 1) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "top") +
  ylim(0, 1) +
  labs(x = "Time", y = "Survival Probability", color = "Subject")

# Combine plots
p1 | p2 | p3
```


## Code of Conduct

Please note that the JointODE project is released with a [Contributor Code of Conduct](http://gongziyang.com/JointODE/CODE_OF_CONDUCT.html). By contributing to this project, you agree to abide by its terms.

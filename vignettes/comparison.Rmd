---
title: "Comparison"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Comparison}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  message = FALSE,
  warning = FALSE
)
```


```{r load-packages, echo=FALSE}
library(JointODE)
library(JSM)
library(nlme)
library(survival)
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)

set.seed(42)
```

## Simulation Setup

The `sim` dataset was generated using a joint ODE framework with the following structure:

**Longitudinal Process:**

The observed biomarker measurements are:
$$v_{ij} = m_i(t_{ij}) + b_i + \epsilon_{ij}$$

where the true biomarker trajectory $m_i(t)$ evolves according to:

$$\ddot{m}_i(t) = \beta_1 m_i(t) + \beta_2 \dot{m}_i(t) + \beta_3 + \beta_4 x_{i1} + \beta_5 x_{i2} + \beta_6 t$$

with $b_i \sim \mathcal{N}(0, \sigma_b^2)$ (random intercept) and $\epsilon_{ij} \sim \mathcal{N}(0, \sigma_e^2)$ (measurement error).

**Survival Process:**

The hazard function incorporates biomarker dynamics:
$$\lambda_i(t) = \lambda_0(t) \exp\{\alpha_1 m_i(t) + \alpha_2 \dot{m}_i(t) + \alpha_3 \ddot{m}_i(t) + \phi_1 w_{i1} + \phi_2 w_{i2} + b_i\}$$

where $\lambda_0(t)=8$ is the baseline hazard and $\alpha = (\alpha_1, \alpha_2, \alpha_3)$ captures the association with biomarker value, velocity, and acceleration.

```{r params-data, echo=FALSE}
# Load data
long_data <- sim$data$longitudinal_data
surv_data <- sim$data$survival_data

# Display parameters
hazard_params <- sim$parameters$coefficients$hazard
accel_params <- sim$parameters$coefficients$acceleration

cat("True Parameters:\n")
cat(sprintf(
  "  Hazard: α = [%.1f, %.1f, %.1f], φ = [%.1f, %.1f]\n",
  hazard_params[1], hazard_params[2], hazard_params[3],
  hazard_params[4], hazard_params[5]
))
cat(sprintf(
  "  ODE: β = [%.1f, %.1f, %.1f, %.1f, %.1f, %.1f]\n",
  accel_params[1], accel_params[2], accel_params[3],
  accel_params[4], accel_params[5], accel_params[6]
))
cat(sprintf(
  "  Variance: σ_e = %.1f, σ_b = %.1f\n",
  sim$parameters$coefficients$measurement_error_sd,
  sim$parameters$coefficients$random_effect_sd
))

cat(sprintf(
  "\nDataset: %d subjects, %d observations, %.0f%% events\n",
  n_distinct(long_data$id), nrow(long_data),
  100 * mean(surv_data$status)
))
```


### ODE Dynamics

```{r viz-combined, fig.width=10, fig.height=4, echo=FALSE}
library(patchwork)

# Select example subjects
set.seed(42)
example_ids <- sample(unique(long_data$id), 4)

# Left plot: ODE dynamics
dynamics_data <- long_data %>%
  filter(id %in% example_ids) %>%
  select(id, time, biomarker, velocity, acceleration) %>%
  pivot_longer(c(biomarker, velocity, acceleration),
    names_to = "component",
    values_to = "value"
  ) %>%
  mutate(component = factor(component,
    levels = c("biomarker", "velocity", "acceleration"),
    labels = c("m(t)", "dm/dt", "d²m/dt²")
  ))

p1 <- ggplot(dynamics_data, aes(x = time, y = value, color = component)) +
  geom_line(size = 0.8) +
  facet_wrap(~ paste("Subject", id), scales = "free_y", ncol = 2) +
  scale_color_manual(values = c("#27AE60", "#3498DB", "#9B59B6")) +
  theme_minimal(base_size = 10) +
  theme(legend.position = "top") +
  labs(
    title = "ODE Dynamics",
    subtitle = "True trajectories and derivatives",
    x = "Time",
    y = "Value",
    color = ""
  )

# Right plot: Measurement error
error_examples <- long_data %>%
  filter(id %in% example_ids)

p2 <- ggplot(error_examples, aes(x = time)) +
  geom_line(aes(y = biomarker, color = "True"), size = 1) +
  geom_point(aes(y = v, color = "Observed"), alpha = 0.6, size = 1.2) +
  facet_wrap(~ paste("Subject", id), scales = "free_y", ncol = 2) +
  scale_color_manual(values = c("True" = "#27AE60", "Observed" = "#E74C3C")) +
  theme_minimal(base_size = 10) +
  theme(legend.position = "top") +
  labs(
    title = "Measurement Error",
    subtitle = "Observed vs true values",
    x = "Time",
    y = "Biomarker Value",
    color = ""
  )

# Combine plots side by side
p1 | p2
```

The left panel shows the complete ODE dynamics for four randomly selected subjects, illustrating how the biomarker value, velocity, and acceleration evolve over time. The right panel demonstrates the impact of random intercept and measurement error by comparing the true biomarker trajectories (lines) with the observed measurements (points).

```{r ode-stats, echo=FALSE}
# Calculate variance and correlation
ode_stats <- long_data %>%
  select(biomarker, velocity, acceleration) %>%
  summarise(
    var_biomarker = var(biomarker),
    var_velocity = var(velocity),
    var_acceleration = var(acceleration)
  )

ode_cor <- cor(long_data[c("biomarker", "velocity", "acceleration")])

# Display statistics
cat("Variance Components:\n")
cat(sprintf("  Biomarker: %.3f\n", ode_stats$var_biomarker))
cat(sprintf("  Velocity: %.3f\n", ode_stats$var_velocity))
cat(sprintf("  Acceleration: %.3f\n", ode_stats$var_acceleration))

cat("\nPairwise Correlations:\n")
cat(sprintf("  ρ(Biomarker, Velocity): %.3f\n", ode_cor[1, 2]))
cat(sprintf("  ρ(Biomarker, Acceleration): %.3f\n", ode_cor[1, 3]))
cat(sprintf("  ρ(Velocity, Acceleration): %.3f\n", ode_cor[2, 3]))
```

The variance hierarchy and correlation structure reflect the fundamental properties of the ODE system. Unlike independent variables in traditional models, these components are mechanistically linked through differential equations, creating intrinsic dependencies that capture the true dynamics of biomarker evolution.


### Survival Distribution

```{r viz-survival, fig.height=3, echo=FALSE}
# Kaplan-Meier curve
km_fit <- survfit(Surv(time, status) ~ 1, data = surv_data)

plot(km_fit,
  xlab = "Time",
  ylab = "Survival Probability",
  main = "Kaplan-Meier Survival Curve",
  conf.int = TRUE,
  mark.time = FALSE,
  lwd = 2.5,
  col = "#2C3E50",
  conf.int.style = "step",
  conf.int.fill = "#E8F4F8"
)
grid(lty = 2, col = "gray85")

# Add median survival line
if (!is.na(median(km_fit))) {
  abline(h = 0.5, lty = 2, col = "gray60")
  abline(v = median(km_fit), lty = 2, col = "gray60")
  text(median(km_fit) + 0.5, 0.05,
    sprintf("Median: %.1f", median(km_fit)),
    cex = 0.9, col = "gray40"
  )
}
```

The survival curve shows the overall event pattern in the simulated dataset, with the shaded area representing the 95% confidence interval.

## Model Comparison

We compare our proposed method against existing approaches:

| Model | Method Type | Data Source | Key Features |
|-------|------------|-------------|--------------|
| **JointODE** | Proposed | Noisy observations | ODE-based; estimates m(t), ṁ(t), m̈(t) |
| **JSM** | Baseline | Noisy observations | Linear mixed effects; only models m(t) |
| **Time-varying Cox (Oracle)** | Upper bound | True ODE values + $b_i$ | MPLE benchmark with true values |

The Oracle model uses the true biomarker trajectory, derivatives, and random effects at observed time points. While it has perfect information, it approximates the time-varying covariates using piecewise linear interpolation rather than modeling the continuous ODE dynamics.

Based on 200 simulation replicates, we evaluate the estimation accuracy of the association parameters $(\alpha_1, \alpha_2, \alpha_3)$ and baseline covariate effects $(\phi_1, \phi_2)$ using Bias, Empirical Standard Error (ESE), Average Standard Error (ASE), and Coverage Probability (CP) of 95% confidence intervals.

```{r sim-results-table, echo=FALSE}
# Create the results data frame without row numbers
results_df <- data.frame(
  Parameter = c(
    "**Baseline Covariates**",
    "φ₁ = 0.8", "", "",
    "φ₂ = -1.2", "", "",
    "**Association Parameters**",
    "α₁ = 0.6", "", "",
    "α₂ = 1.0", "",
    "α₃ = -1.5", ""
  ),
  Model = c(
    "",
    "TVCox", "JSM", "JointODE",
    "TVCox", "JSM", "JointODE",
    "",
    "TVCox", "JSM", "JointODE",
    "TVCox", "JointODE",
    "TVCox", "JointODE"
  ),
  Bias = c(
    "",
    "0.032", "-0.067", "0.036",
    "-0.038", "0.109", "-0.046",
    "",
    "-0.057", "0.300", "0.062",
    "0.361", "-0.193",
    "0.182", "0.168"
  ),
  ESE = c(
    "",
    "0.147", "0.135", "0.135",
    "0.156", "0.138", "0.145",
    "",
    "0.235", "0.252", "0.161",
    "0.459", "0.360",
    "0.332", "0.339"
  ),
  ASE = c(
    "",
    "0.136", "0.137", "0.137",
    "0.155", "0.153", "0.154",
    "",
    "0.219", "0.290", "0.210",
    "0.423", "0.339",
    "0.299", "0.282"
  ),
  CP = c(
    "",
    "92.5", "90.4", "95.9",
    "95.5", "88.9", "96.4",
    "",
    "93.5", "86.9", "98.5",
    "85.0", "91.4",
    "84.5", "87.8"
  )
)

# Use kable with row.names = FALSE to remove row numbers
kable(results_df,
  col.names = c("Parameter", "Model", "Bias", "ESE", "ASE", "CP (%)"),
  align = c("l", "l", "r", "r", "r", "r"),
  row.names = FALSE
)
```

## Appendix

```{r model-implementation, eval=FALSE}
# Data preparation for comparison models
jsm_data <- dataPreprocess(
  long = long_data %>% rename(ID = id),
  surv = surv_data %>% rename(ID = id, survtime = time),
  id.col = "ID",
  long.time.col = "time",
  surv.time.col = "survtime",
  surv.event.col = "status"
) %>%
  rename(
    obstime = time,
    start = start.join,
    stop = stop.join,
    event = event.join
  )

#--------------------------------------------
# Model 1: JointODE (Proposed Method)
#--------------------------------------------
fit_jointode <- JointODE(
  longitudinal_formula = sim$formulas$longitudinal,
  longitudinal_data = sim$data$longitudinal_data,
  survival_formula = sim$formulas$survival,
  survival_data = sim$data$survival_data
)

#--------------------------------------------
# Model 2: Traditional Joint Model (JSM)
#--------------------------------------------
# Step 1: Longitudinal sub-model
fit_lme <- lme(
  v ~ obstime + x1 + x2,
  random = ~ 1 | ID,
  data = jsm_data
)

# Step 2: Survival sub-model
fit_cox <- coxph(
  Surv(start, stop, event) ~ w1 + w2,
  data = jsm_data, x = TRUE
)

# Step 3: Joint model
fit_jsm <- jmodelTM(
  fit_lme, fit_cox,
  data = jsm_data,
  timeVarY = "obstime"
)

#--------------------------------------------
# Model 3: Time-varying Cox (Oracle - Theoretical Benchmark)
#--------------------------------------------
fit_oracle <- coxph(
  Surv(start, stop, event) ~ w1 + w2 + biomarker + velocity + acceleration +
    offset(b) + cluster(ID),
  data = jsm_data
)
```
